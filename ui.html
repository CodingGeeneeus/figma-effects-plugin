<style>
.hidden {
  display: none;
}
</style>

<h2>Image Effects</h2>
<canvas class="preview" width="0" height="0"></canvas>
<div 
  id="dropbox" 
  style="
  width: 90%;
  height: 75px;
  border: 1px solid black;
  border-radius: 5px;
  "
></div>
<button id="get-selection">Use Current Selection</button>
<button id="blur" style="display: block;">Blur</button>
<button id="create">Create</button>
<button id="cancel">Cancel</button>
<script>

let currentSelection;

function applyConvolution( sourceImageData, kernel) {

  const src = sourceImageData.data;
  
  const srcWidth = sourceImageData.width;
  const srcHeight = sourceImageData.height;
  
  const side = Math.round(Math.sqrt(kernel.length));
  const halfSide = Math.floor(side/2);
  
  // padding the output by the convolution kernel
  const w = srcWidth;
  const h = srcHeight;
  
  // iterating through the output image pixels
  for (let y = 0; y < h; y++) {
    for (let x = 0; x < w; x++) {      
      let r = 0, g = 0, b = 0, a = 0;
      
      // calculating the weighed sum of the source image pixels that
      // fall under the convolution kernel
      for (let cy = 0; cy < side; cy++) {
        for (let cx = 0; cx < side; cx++) {
          const scy = y + cy - halfSide;
          const scx = x + cx - halfSide;
          
          if (scy >= 0 && scy < srcHeight && scx >= 0 && scx < srcWidth) {
            let srcOffset = (scy*srcWidth+scx) * 4;
            let wt = kernel[cy*side+cx];
            r += src[srcOffset] * wt;
            g += src[srcOffset+1] * wt;
            b += src[srcOffset+2] * wt;
            a += src[srcOffset+3] * wt;
          }
        }
      }
      
      const dstOffset = (y*w+x)*4;
      
      src[dstOffset] = r;
      src[dstOffset+1] = g;
      src[dstOffset+2] = b;
      src[dstOffset+3] = a;
    }
  }
  
  return sourceImageData;
};

function blobToPNG(blob){
  return new Promise(resolve => {
    const url = URL.createObjectURL(blob)
    let image = new Image()
    image.onload = () => {
      URL.revokeObjectURL(url);
      resolve(image)
    }
    image.src = url
  })
}

async function renderUint8(Uint8, width, height) {
  const preview = document.querySelector('.preview');
  const ctx = preview.getContext('2d');

  const blob = new Blob([Uint8], {type: "image/png"})
  const image = await blobToPNG(blob);

  preview.width = width;
  preview.height = height

  ctx.drawImage(image, 0, 0)
  parent.postMessage( { pluginMessage: { type: 'resize', width: width, height: height }}, '*' )
}


onmessage = e => {
  const msg = e.data.pluginMessage
  if(msg.type == 'preview'){
    previewImage(msg.file)
  }

  if(msg.type === 'current-selection'){
    currentSelection = msg.payload
    const width = msg.width;
    const height = msg.height;

    // console.log(currentSelection);
    renderUint8(currentSelection, width, height); 

  }

}

const dragEnter = (e) => {
  e.stopPropagation();
  e.preventDefault();
}

const dragOver = (e) => {
  e.stopPropagation();
  e.preventDefault();
}

const drop = (e) => {
  e.stopPropagation();
  e.preventDefault();

  const dt = e.dataTransfer;
  const files = dt.files;

  handleFiles(files);
}

function handleFiles(files) {

  if(files.length > 1){
    alert('Only one file at a time accepted')
    return
  } else if (files[0].type.split('/')[0] !== 'image') {
    alert("Only images are accepted!")
    return
  } else {
    dropbox.classList.add('hidden')
    previewImage(files[0])
  };
  
};

function previewImage(file) {
  const preview = document.querySelector('.preview');
  const ctx = preview.getContext('2d');


  const image = new Image();
  const reader = new FileReader();

  if (file) {
    reader.readAsDataURL(file)
  }

  reader.addEventListener('load', () => {
    image.src = reader.result

    const bytes = image.src.split(',')[1]
    const _imageType = file.type.split('/')[1]

    parent.postMessage({ pluginMessage: { type:'image-data', imageType: _imageType, bytes: bytes }}, '*')
    image.addEventListener('load', () => {
      preview.width = image.width;
      preview.height = image.height;
      //draws it to the canvas
      ctx.drawImage(image, 0, 0);

      const newWidth = image.width + 100;
      const newHeight = image.height + 200;
      parent.postMessage( { pluginMessage: { type: 'resize', width: newWidth, height: newHeight }}, '*' )
    });
  });
}

const blur = document.getElementById('blur');

blur.addEventListener('click', () => {
  const canvas = document.querySelector('.preview');
  const width = canvas.width;
  const height = canvas.height;

  const ctx = canvas.getContext('2d');

  const imageData = ctx.getImageData(0, 0, width, height);

  const newImage = applyConvolution(imageData, [
      1 / 16, 2 / 16, 1 / 16,
      2 / 16, 4 / 16, 2 / 16,
      1 / 16, 2 / 16, 1 / 16
    ])
  ctx.putImageData(newImage, 0, 0 )
  console.log(newImage)

});

const grayscale = (ctx, canvas) => {
  const imageData = ctx.getImageData(0, 0, canvas.width, canvas.height);
  const data = imageData.data;
  for (let i = 0; i < data.length; i += 4) {
    const avg = (data[i] + data[i + 1] + data[i + 2]) / 3;
    data[i] = avg; // red
    data[i + 1] = avg; // green
    data[i + 2] = avg; // blue
  }
  ctx.putImageData(imageData, 0, 0);
};

const getSelection = document.getElementById('get-selection');

getSelection.addEventListener('click', () => {
  parent.postMessage({pluginMessage: { type: 'get-selection' }}, '*')
})

let dropbox = document.getElementById('dropbox');

dropbox.addEventListener("dragenter", dragEnter);
dropbox.addEventListener("dragover", dragOver);
dropbox.addEventListener("drop", drop);

document.getElementById('create').onclick = () => {
  const file = document.getElementById('file').files[0];
  // parent.postMessage({ pluginMessage: { type: 'create-effect', img} }, '*')
}

document.getElementById('cancel').onclick = () => {
  parent.postMessage({ pluginMessage: { type: 'cancel' } }, '*')
}

</script>
